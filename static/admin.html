<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: linear-gradient(135deg, #6a11cb, #2575fc); color: #333; }
    h1, h2, h3 { margin: 0 0 10px; }
    button { cursor: pointer; transition: transform 0.2s; }
    button:hover { transform: scale(1.03); }
    header { background: #fff; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    header h1 { color: #6a11cb; }
    header button { background: #ff416c; color: #fff; border: none; padding: 10px 16px; border-radius: 8px; }
    main { padding: 40px; max-width: 1200px; margin: auto; }
    section { background: #fff; margin-bottom: 40px; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
    hr { border: none; height: 1px; background: #eee; margin: 40px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px 15px; text-align: left; }
    thead { background: #6a11cb; color: #fff; }
    tbody tr:nth-child(even) { background: #f9f9f9; }
    tbody tr:hover { background: #eef; }
    th { border-bottom: 2px solid #ddd; }
    td { border-bottom: 1px solid #eee; }
    input[type="text"], input[type="password"], input[type="date"], select { width: 100%; padding: 8px 10px; margin: 6px 0 12px; border: 1px solid #ccc; border-radius: 6px; }
    .flex-row { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
    .flex-row label { margin: 0; }
    .flex-row input { max-width: 200px; }
    .btn { padding: 10px 20px; border: none; border-radius: 8px; color: #fff; background: linear-gradient(135deg, #ff416c, #ff4b2b); }
    .btn.secondary { background: #ccc; color: #333; }
    #views-chart, #downloads-chart { background: #fafafa; border: 1px solid #ddd; border-radius: 6px; }
  </style>
</head>
<body>
  <header>
    <h1>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
    <button onclick="logout()">–í—ã–π—Ç–∏</button>
  </header>
  <main>

    <!-- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
<section id="user-management">
      <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
      <button class="btn" onclick="showCreateUserForm()">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>–õ–æ–≥–∏–Ω</th>
            <th>–†–æ–ª—å</th>
            <th>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</th>
            <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="users-table-body"></tbody>
      </table>

      <div id="user-form" style="display:none; margin-top:30px;">
        <h3 id="user-form-title">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
        <input type="hidden" id="form-user-id">
        <label>–õ–æ–≥–∏–Ω:</label>
        <input type="text" id="form-username" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
        <label>–ü–∞—Ä–æ–ª—å:</label>
        <input type="password" id="form-password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
        <label>–†–æ–ª—å:</label>
        <select id="form-role">
          <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
          <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
        </select>
        <div style="margin-top:20px; display:flex; gap:10px;">
          <button class="btn" onclick="submitUserForm()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn secondary" onclick="hideUserForm()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </section>

    <hr>
    <section id="user-logs">
      <h2>–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
      <table>
        <thead><tr><th>ID</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th><th>–í—Ä–µ–º—è</th></tr></thead>
        <tbody id="logs-table-body"></tbody>
      </table>
    </section>

    <!-- –ü—Ä–æ—Å–º–æ—Ç—Ä—ã -->
    <section id="views-report">
      <h2>–û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º —Å—Ç–∞—Ç–µ–π</h2>
      <div class="flex-row">
        <label>–°:</label><input type="date" id="views-start">
        <label>–ü–æ:</label><input type="date" id="views-end">
        <button class="btn" onclick="loadViewsReport()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      </div>
      <div id="views-chart" style="width:100%; height:300px; margin-top:20px;"></div>
      <h3 style="margin-top:40px;">–î–µ—Ç–∞–ª–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</h3>
      <table>
        <thead><tr><th>–°—Ç–∞—Ç—å—è</th><th>–î–∞—Ç–∞</th><th>–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</th></tr></thead>
        <tbody id="views-table-body"></tbody>
      </table>
    </section>

    <hr>

    <!-- –°–∫–∞—á–∏–≤–∞–Ω–∏—è -->
    <section id="downloads-report">
      <h2>–û—Ç—á—ë—Ç –ø–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è–º —Å—Ç–∞—Ç–µ–π</h2>
      <div class="flex-row">
        <label>–°:</label><input type="date" id="dl-start">
        <label>–ü–æ:</label><input type="date" id="dl-end">
        <button class="btn" onclick="loadDownloadsReport()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      </div>
      <div id="downloads-chart" style="width:100%; height:300px; margin-top:20px;"></div>
      <h3 style="margin-top:40px;">–î–µ—Ç–∞–ª–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π</h3>
      <table>
        <thead><tr><th>–°—Ç–∞—Ç—å—è</th><th>–î–∞—Ç–∞</th><th>–°–∫–∞—á–∏–≤–∞–Ω–∏–π</th></tr></thead>
        <tbody id="downloads-table-body"></tbody>
      </table>
    </section>

    <section id="clustering-panel">
    <h2>–ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π</h2>
    <form id="cluster-form">
      <label>–í—ã–±–µ—Ä–∏—Ç–µ –≤—ã–ø—É—Å–∫–∏:</label>
      <div id="cluster-issues"></div>
      <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤:</label>
      <input type="number" name="num_clusters" id="num_clusters" min="2" value="3" required>
      <button class="btn" type="submit">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—é</button>
    </form>
    <div id="cluster-result" style="margin-top:20px;">
    </div>
  </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <script>
    async function logout() {
      await fetch('/logout', { method: 'POST' });
      location.href = '/';
    }

    // ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    async function loadUsers() {
      const res = await fetch('/admin/users');
      const { users } = await res.json();
      const tbody = document.getElementById('users-table-body');
      tbody.innerHTML = '';
      users.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${u.id}</td>
          <td>${u.username}</td>
          <td>${u.role}</td>
          <td>${new Date(u.created_at).toLocaleString()}</td>
          <td>${new Date(u.last_login).toLocaleString()}</td>
          <td>
            <button class="btn secondary" onclick="editUser(${u.id},'${u.username}','${u.role}')">–ò–∑–º–µ–Ω–∏—Ç—å</button>
            <button class="btn secondary" style="background:#c00;color:#fff;" onclick="deleteUser(${u.id})">–£–¥–∞–ª–∏—Ç—å</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function showCreateUserForm() {
      document.getElementById('user-form-title').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
      document.getElementById('form-user-id').value = '';
      document.getElementById('form-username').value = '';
      document.getElementById('form-password').value = '';
      document.getElementById('form-role').value = 'user';
      document.getElementById('user-form').style.display = 'block';
    }

    function hideUserForm() {
      document.getElementById('user-form').style.display = 'none';
    }

    function editUser(id, username, role) {
      document.getElementById('user-form-title').textContent = '–ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
      document.getElementById('form-user-id').value = id;
      document.getElementById('form-username').value = username;
      document.getElementById('form-password').value = '';
      document.getElementById('form-role').value = role;
      document.getElementById('user-form').style.display = 'block';
    }

    async function submitUserForm() {
      const id = document.getElementById('form-user-id').value;
      const fd = new FormData();
      fd.append('username', document.getElementById('form-username').value);
      const pw = document.getElementById('form-password').value;
      if (pw) fd.append('password', pw);
      fd.append('role', document.getElementById('form-role').value);
      const url = id ? `/admin/users/${id}` : '/admin/users';
      const method = id ? 'PUT' : 'POST';
      const res = await fetch(url, { method, body: fd });
      if (res.ok) {
        hideUserForm();
        loadUsers();
      } else {
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      }
    }

    async function deleteUser(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
      const res = await fetch(`/admin/users/${id}`, { method: 'DELETE' });
      if (res.ok) loadUsers();
      else alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
    }

    // üìä –ü—Ä–æ—Å–º–æ—Ç—Ä—ã
    async function loadViewsReport() {
      const start = document.getElementById('views-start').value;
      const end = document.getElementById('views-end').value;
      const res = await fetch(`/admin/reports/views?start=${start}&end=${end}`);
      const { reports } = await res.json();
      const chartV = echarts.init(document.getElementById('views-chart'));
      const dates = [...new Set(reports.map(r => r.view_date))].sort();
      const counts = dates.map(d => reports.filter(r => r.view_date === d).reduce((sum, r) => sum + r.view_count, 0));
      chartV.setOption({
        xAxis: {
          type: 'category',
          data: dates,
          name: '–î–∞—Ç–∞',
          nameLocation: 'middle',
          nameGap: 30
        },
        yAxis: {
          type: 'value',
          name: '–ß–∏—Å–ª–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤',
          nameLocation: 'middle',
          nameGap: 50
        },
        series: [{ data: counts, type: 'scatter' }],
        tooltip: { trigger: 'axis' }
      });
      const tbody = document.getElementById('views-table-body');
      tbody.innerHTML = '';
      reports.sort((a,b) => b.view_count - a.view_count).forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.title}</td><td>${new Date(r.view_date).toLocaleDateString()}</td><td>${r.view_count}</td>`;
        tbody.appendChild(tr);
      });
    }

    // üì• –°–∫–∞—á–∏–≤–∞–Ω–∏—è
    async function loadDownloadsReport() {
      const start = document.getElementById('dl-start').value;
      const end = document.getElementById('dl-end').value;
      const res = await fetch(`/admin/reports/downloads?start=${start}&end=${end}`);
      const { reports } = await res.json();
      const chartD = echarts.init(document.getElementById('downloads-chart'));
      const dates = [...new Set(reports.map(r => r.download_date))].sort();
      const counts = dates.map(d => reports.filter(r => r.download_date === d).reduce((sum, r) => sum + r.download_count, 0));
      chartD.setOption({
        xAxis: {
          type: 'category',
          data: dates,
          name: '–î–∞—Ç–∞',
          nameLocation: 'middle',
          nameGap: 30
        },
        yAxis: {
          type: 'value',
          name: '–ß–∏—Å–ª–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π',
          nameLocation: 'middle',
          nameGap: 50
        },
        series: [{ data: counts, type: 'scatter' }],
        tooltip: { trigger: 'axis' }
      });
      const tbody = document.getElementById('downloads-table-body');
      tbody.innerHTML = '';
      reports.sort((a,b) => b.download_count - a.download_count).forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.title}</td><td>${new Date(r.download_date).toLocaleDateString()}</td><td>${r.download_count}</td>`;
        tbody.appendChild(tr);
      });
    }
    async function loadUserLogs() {
      const res = await fetch('/admin/logs');
      const { logs } = await res.json();
      const tbody = document.getElementById('logs-table-body');
      tbody.innerHTML = '';
      logs.forEach(log => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${log.id}</td><td>${log.username}</td><td>${log.action}</td><td>${new Date(log.action_time).toLocaleString()}</td>`;
        tbody.appendChild(tr);
      });
}


    document.addEventListener('DOMContentLoaded', () => {
      loadUsers(); // ‚úÖ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      const today = new Date().toISOString().slice(0,10);
      document.getElementById('views-start').value = today;
      document.getElementById('views-end').value = today;
      document.getElementById('dl-start').value = today;
      document.getElementById('dl-end').value = today;
      loadViewsReport();
      loadDownloadsReport();
      loadUserLogs();

    });

           async function loadClusterIssues() {
      const res = await fetch("/issues");
      const issues = await res.json();
      const container = document.getElementById("cluster-issues");
      container.innerHTML = "";
      issues.forEach(i => {
        container.innerHTML += `<label><input type="checkbox" name="issue_ids" value="${i.id}"> ${i.title} (${i.year})</label><br>`;
      });
    }

    document.getElementById("cluster-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData();
      const checkboxes = form.querySelectorAll("input[name='issue_ids']:checked");
      checkboxes.forEach(cb => formData.append("issue_ids", cb.value));
      formData.append("num_clusters", form.num_clusters.value);

      const res = await fetch("/admin/clusterize", {
        method: "POST",
        body: formData
      });

      const data = await res.json();
      if (data.plot_html) {
      const iframe = document.createElement("iframe");
      iframe.style.width = "100%";
      iframe.style.height = "700px";
      iframe.style.border = "none";
      iframe.srcdoc = atob(data.plot_html);  // ‚¨ÖÔ∏è –¥–µ–∫–æ–¥–∏—Ä—É–µ–º HTML-–≥—Ä–∞—Ñ–∏–∫
      const container = document.getElementById("cluster-result");
      container.innerHTML = "";  // –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞
      container.appendChild(iframe);
    } else {
      alert(data.error || "–û—à–∏–±–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏");
    }
    });
   document.addEventListener("DOMContentLoaded", loadClusterIssues);
  </script>
</body>
</html>
